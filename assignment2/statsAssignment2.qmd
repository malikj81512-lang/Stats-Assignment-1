---
title: "ED Assignment"
format: pdf
editor: visual
author: Malik Jamie (JMXMAL003) and Amara Patel (PTLAMA005)
date: 2025.10.21
---

# Introduction

The aim of this experiment is to examine the effects of different intensities of heat and light on the growth of chilli plants. The goal is to determine whether light and heat affect chilli growth, which settings produce the highest quality chillies and by how much. Furthermore, whether these settings depend on variety as well as whether quality depends on variety will be explored. This is to make recommendations about which heat and light settings are optimal for small-scale farmers to implement, taking into account the cost of additional heat and light.

These goals will be tackled through an analysis of variance of this exploratory experiment.

# Design and Randomisation

### Design

The experiment takes place over 2 seasons, season 1 and season 2. There are two greenhouses available, greenhouse A and greenhouse B, with 8 north-facing and 8 south-facing plots each. The 32 experimental units were first blocked by the random factors, season and greenhouse, to give four blocks of 16 experimental units each. The treatment factors are side (north, south) and variety (Redhot, Furious), each with two levels which results in a $2^2$ factorial treatment structure with 4 treatments, (n,F), (s,F), (n,R), (s,R).

### Randomisation

Four 4x4 latin square designs were set up with the four levels of light (1, 2, 3, 4) as a row block and the four levels of heat (1, 2, 3, 4) as a column block To conduct randomisation, a random latin square permutation of the four treatments with each appearing once in every row and column was found for each season-greenhouse combination using the design.lsd function from the agricolae package. The four treatments were randomly assigned to "a", "b", "c" and "d" for ease of understanding the latin square design layout. 

```{r Design and Randomisation, echo = FALSE}

suppressPackageStartupMessages({
library(dplyr, quietly = TRUE)
library(knitr)
library(tibble)
library(agricolae)
library(tidyr)
library(EDproject)
library(ggplot2)
library(tinytex)})

# model: essentially, side and variety are treated as treatment factors w 2 levels each, resulting in 4 combinations in a factorial experiment. light and heat are treated as blocking factors within each greenhouse-season block. 4, 4x4 lsds are created with rows corresponding to light levels and columns corresponding to heat levels and the four side-variety treatments are assigned in a standard 4x4 lsd. the model ends up being Y = mu + heat + light + season + greenhouse + side + variety + side*variety + heat*light + variety*heat + variety*light + variety*heat*light + error term. end up with 16 replicates per treatment of side-variety

set.seed(15)

# treatments 
treatments2 <- c("n,R", "s,F", "n,F", "s,R")

# create design (again oh my god)

mydesign2 <- expand.grid(season = 1:2, greenhouse = c("A", "B") ) %>%
  
  # new lsd for each season-greenhouse block w individual seed
  mutate(
    square_id = 1:n(),
    latin_seed = 15 + square_id
  ) %>%
  rowwise() %>% 
  mutate(
    latin_square = list(
      design.lsd(treatments2, serie = 0, seed = latin_seed)$book)
  ) %>%
  ungroup() %>% 
  
  # getting latin square into separate elements to be able to put it into the data frame 
  tidyr::unnest(latin_square) %>%
  rename(
    row = row,
    column = col,
    treatment = treatments2
  ) %>%
  
  # splitting the treatments into individual factors applied to put into design
  separate(treatment, into = c("side", "variety"), sep = ",") %>%
mutate(
    light = row,    # rows correspond to light levels (1-4)
    heat = column   # columns correspond to heat levels (1-4)
  ) %>%
  
# adding plot numbers (1-32 for season 1, 2)
  group_by(season) %>%
  mutate(plot = 1:n()) %>%
  ungroup() %>%
  select(plot, season, greenhouse, side, variety, light, heat) %>%
  arrange(season, plot) 

write.csv(mydesign2, file = "design2.csv", row.names = FALSE)

```


```{r making tables of the latin square designs, echo = FALSE}

set.seed(2)
treatment_mapping <- data.frame(
  side = c("n", "s", "n", "s"),
  variety = c("R", "F", "F", "R")
) %>%
  mutate(
    treatment = paste0(side, variety),
    code = sample(c("a", "b", "c", "d"))   # Random assignment 
  ) %>% 
  arrange(code)

# Create the complete data frame with codes
design_with_codes <- mydesign2 %>%
  # First, handle duplicates by taking the first occurrence
  group_by(season, greenhouse, light, heat) %>%
  slice(1) %>%
  ungroup() %>%
  # Add the treatment code
  mutate(treatment = paste0(side, variety)) %>%
  left_join(treatment_mapping %>% select(treatment, code), by = "treatment") %>%
  # Select and order the columns
  select(plot, season, greenhouse, side, variety, treatment, code, light, heat) %>%
  arrange(season, greenhouse, heat)

# making the latin square layouts
key <- tibble(treatment = treatment_mapping$treatment,
              code = treatment_mapping$code)
kable(key, caption = "Randomly assigned treatment codes")
lsd1 <- tibble(light_lvl = c(1, 2, 3, 4),
               design_with_codes$code[1:4],
               design_with_codes$code[5:8],
               design_with_codes$code[9:12],
               design_with_codes$code[13:16]
)
kable(lsd1, col.names = c("","1", "2", "3", "4"), caption = "LSD for Greenhouse A, Season 1")

lsd2 <- tibble(light_lvl = c(1, 2, 3, 4),
               design_with_codes$code[17:20],
               design_with_codes$code[21:24],
               design_with_codes$code[25:28],
               design_with_codes$code[29:32]
)
kable(lsd2, col.names = c("","1", "2", "3", "4"), caption = "LSD for Greenhouse B, Season 1")

lsd3 <- tibble(light_lvl = c(1, 2, 3, 4),
               design_with_codes$code[33:36],
               design_with_codes$code[37:40],
               design_with_codes$code[41:44],
               design_with_codes$code[45:48]
)
kable(lsd3, col.names = c("","1", "2", "3", "4"), caption = "LSD for Greenhouse A, Season 2")

lsd4 <- tibble(light_lvl = c(1, 2, 3, 4),
               design_with_codes$code[49:52],
               design_with_codes$code[53:56],
               design_with_codes$code[57:60],
               design_with_codes$code[61:64]
)
kable(lsd4, col.names = c("","1", "2", "3", "4"), caption = "LSD for Greenhouse B, Season 2")

```

### Hypotheses 

The a-priori hypotheses that are of interest are:

1: Does the main effect of light have an effect on quality?

2: Does the main effect of heat have an effect on quality?

3: Does the interaction effect between light and heat have an effect on quality?

4: Does the interaction effect between light and variety have an effect on quality? 

5: Does the interaction effect between heat and variety have an effect on quality?

6: Does the main effect of variety have an effect on quality? 

### Justification 
The factorial treatment structure with side and variety (each with two levels) crossed to give four treatment combinations allows for the main effects of variety and side to be tested as well as the interaction effect between side and variety. This allows for the effect of variety on quality to be analysed. 

The four latin squares, with light and heat as blocking factors with four levels each allows for analysis of the variation due to light and heat in a balanced design as there are four treatments that correspond to the four experimental units in each row or column with each treatment only appearing once in each column and row. This is also an efficient use of resources as 4 replicates of side and variety combinations are available per latin square. The latin structure also allows for the effects of light and heat on quality to be analysed thoroughly and easily. 

Additionally, the factorial treatment structure in conjunction with the latin square design allows for the interactions between light and variety, and heat and variety to be analysed. 

The replication across season-greenhouse blocks accounts for the variation due to season and the variation due to greenhouse and ensures sufficient power for the experiment as the 4 blocks result in $4 \times 4 = 16$ replicates per treatment. 

Essentially, this design allows for efficient analysis of all the a-priori hypotheses of interest and allows for many sources of variation to be accounted for. 

# Analysis and Results
```{r Simulating observations, echo = FALSE}

set.seed(27)  

mydesign2 <- read.csv("design2.csv")
mydesign2$light <- as.factor(mydesign2$light)
mydesign2$heat <- as.factor(mydesign2$heat)
#mydesign2
mydata2 <- get.observations(mydesign2)
mydata2

```
## Analysis

### The model:

$$
Y_{ijklmn} = \mu+ \alpha_i + \beta_j + \gamma_k + \delta_l + (\gamma\delta)_{kl} + \epsilon_m + \theta_n + (\epsilon\theta)_{mn} + (\delta\epsilon)_{km} + (\delta\theta)_{kn} (\delta\epsilon\theta)_{lmn} + e_{ijklmn} 
$$

$$
\begin{aligned}
\Y_{ijklmn} &= \text{quality score for observation ijklmn}\\
\alpha_i &= \text{effect of Season 2 compared to Season 1, $i = 1,2$}\\
\beta_j &= \text{effect of Greenhouse B compared to Greenhouse A, $j = A, B}\\
\gamma_k &= \text{effect of side north compared to south, $k = s, n$}\\
\delta_l &= \text{effect of variety R compared to F, $l = F, R$}\\
\epsilon_m &= \text{effect of $i^{th}$ light level compared to $1^{st}$ level, $1 < i \leq 4$}\\
\theta_n &= \text{effect of $j^{th}$ heat level compared to $1^{st}$ level, $1 < j \leq 4$}
\end{aligned}
$$

An anova table was constructed based on this model with corner-point constraints for each variable as such: 
$$
\begin{align*}
\alpha_1 &= 0 & \text{(Season 1 as reference)} \\
\beta_A &= 0 & \text{(Greenhouse A as reference)} \\
\gamma_s &= 0 & \text{(Side north as reference)} \\
\delta_R &= 0 & \text{(Variety Furious as reference)} \\
\epsilon_1 &= 0 & \text{(Light level 1 as reference)} \\
\theta_1 &= 0 & \text{(Heat level 1 as reference)}
\end{align*}
$$

```{r, fitting model, anova table, echo = FALSE}

model <- lm(obs ~ season + greenhouse + variety*side + light*heat*variety, data=mydata2)
#model
kable(anova(model), caption = "ANOVA table")

```

### Exploratory Data Analysis 
#### Interaction Plots
```{r interaction plot 1, fig.cap = "Interaction plot of light and heat", echo = FALSE}
with(na.omit(mydata2), interaction.plot(light, heat, obs))
```

```{r interaction plot 2, fig.cap = "Interaction plot of light and variety", echo = FALSE}
with(na.omit(mydata2), interaction.plot(light, variety, obs))
```

```{r interaction plot 3, fig.cap = "Interaction plot of heat and variety", echo = FALSE}
with(na.omit(mydata2), interaction.plot(heat, variety, obs))
```

```{r interaction plot 4, fig.cap = "Interaction plot of variety and side", echo = FALSE}
with(na.omit(mydata2), interaction.plot(variety, side, obs))
```

The interaction plot between light and heat suggests that there is minimal interaction between the four levels of each. The interaction plot between variety and side also suggests that there is minimal interaction between side and variety. 
On the other hand, the interaction plots between light and variety and heat and variety suggest some interaction effect. 

#### Boxplots 

```{r boxplot 1, fig.cap = "Boxplot of light levels", echo = FALSE}
with(na.omit(mydata2), ggplot(data = mydata2, aes(x = light, y = obs))) + 
  geom_boxplot(fill = "turquoise") + 
  scale_x_discrete(limits = c("1", "2", "3", "4")) +
  labs(x = "light", y = "quality score")

```

```{r boxplot 2, fig.cap = "Boxplot of heat levels", echo = FALSE}
with(na.omit(mydata2), ggplot(data = mydata2, aes(x = heat, y = obs))) + 
  geom_boxplot(fill = "purple3") + 
  scale_x_discrete(limits = c("1", "2", "3", "4")) +
  labs(x = "heat", y = "quality score")

```

```{r boxplot 1, fig.cap = "Boxplot of variety", echo = FALSE}
with(na.omit(mydata2), ggplot(data = mydata2, aes(x = variety, y = obs))) + 
  geom_boxplot(fill = "pink2") + 
  #scale_x_discrete(limits = c("F", "R")) +
  labs(x = "variety", y = "quality score")

```


## Results

```{r}
confint(model, parm = "season")
confint(model, parm = "greenhouseB")
confint(model, parm = "varietyR")
confint(model, parm = "sides")

```

##. Main effects

From our analysis, there is strong evidence for an effect on quality due to season (p-val < 0.00001). In season 2 of testing, the mean response was 3.230 higher than in season 1, holding all other variables constant, with a 95% confidence interval = (2.284, 4.175). 
There is evidence for an effect on quality due to greenhouse (p-val = 0.001). For Greenhouse B, the mean response was 2.671 higher than in Greenhouse A (1.600, 3.741), holding all other variables constant. 
There is no strong evidence for an effect on quality due to variety (p-val = 0.240).
There is strong evidence for an effect due to side (p-val < 0.00001). On the south side, the mean response was 3.057 lower than on the north side (-4.821, -1.293), holding all other variables constant.

## Does the optimal heat and light settings depend on variety?


```{r}

library(emmeans)

#emmeans(model, ~ variety)

emm_l <- emmeans(model, ~ light*variety)

emm_h <- emmeans(model, ~ heat*variety)

contrast(emm_l, 
         list(avg_R_minus_avg_F = c(rep(1/4, 4), rep(-1/4, 4))
              ), by = NULL)

contrast(emm_h, 
         list(avg_R_minus_avg_F = c(rep(1/4, 4), rep(-1/4, 4))
              ), by = NULL )

```

Our F-test analysis provides evidence for an interaction effect between variety and light (p-val < 0.05), as well as between variety and heat (p-val < 0.05). Therefore, we can proceed under the assumption that the optimal heat and light settings do depend on variety.

### Which light and heat settings produce the highest quality chillies?

From the ANOVA table, there was no evidence for the interaction term between light and heat being significant (p-val = 0.2643), nor the interaction term between light, heat and variety (p-val = 0.218). 
However, there is evidence for the interaction term between light and variety being significant (p-val = 0.0032), as well as the interaction term between heat and variety (p-val = 0.0297).
Therefore, to determine the best light and heat settings, we calculated estimated means for heat and light for both varieties, averaging across all levels of other explanatory variables.
Our results suggest that the settings that produced the highest quality chillies, on average, were different between the two varieties of chilli.
For variety F, the light setting that produced the highest quality chillies on average, was level 4, with a mean response of 53.6 (52.6, 55.2). The optimal heat setting was level 3 with a mean response of 52.5 (51.3, 53.6).
For variety R, the optimal light setting was level 4, with a mean response of 54.4 (53.1, 55.7). The optimal heat level 4, with a mean response of 51.1 (49.8, 52.4).
Since the interactions between light, heat and variety were not significant, for each variety, the light and heat settings that would produce the highest quality chillies on average, were simply the settings that had the highest individual means.
Therefore, for variety F, the optimal settings were light level 4 and heat level 3.
For variety R, the optimal settings were light level 4 and heat level 4.

### Does quality depend on variety?

```{r}

library(emmeans)

emmeans(model, ~ variety)


```
0.239746
Our results suggest that there is no evidence for an effect on quality due to variety. The estimated means were very similar: 49.1 for variety F (48.5, 49.7), 49.3 for variety R (48.6, 49.9). Furthermore, the ANOVA table 


