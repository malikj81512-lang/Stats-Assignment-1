---
title: "ED Assignment"
format: pdf
editor: visual
author: Malik Jamie (JMXMAL003) and Amara Patel (PTLAMA005)
date: 2025.10.21
---

# Introduction

The aim of this experiment is to examine the effects of different intensities of heat and light on the growth of chilli plants. The goal is to determine whether light and heat affect chilli growth, which settings produce the highest quality chillies and by how much. Furthermore, whether these settings depend on variety as well as whether quality depends on variety will be explored. This is to make recommendations about which heat and light settings are optimal for small-scale farmers to implement, taking into account the cost of additional heat and light.

These goals will be tackled through an analysis of variance of this exploratory experiment.

# Design and Randomisation

## Design

The experiment takes place over 2 seasons, season 1 and season 2. There are two greenhouses available, greenhouse A and greenhouse B, with 8 north-facing and 8 south-facing plots each. The 32 experimental units were first blocked by the random factors, season and greenhouse, to give four blocks of 16 experimental units each. The treatment factors are side (north, south) and variety (Redhot, Furious), each with two levels which results in a $2^2$ factorial treatment structure with 4 treatments, (n,F), (s,F), (n,R), (s,R).

## Randomisation

Four 4x4 latin square designs were set up with the four levels of light (1, 2, 3, 4) as a row block and the four levels of heat (1, 2, 3, 4) as a column block To conduct randomisation, a random latin square permutation of the four treatments with each appearing once in every row and column was found for each season-greenhouse combination using the design.lsd function from the agricolae package. The four treatments were randomly assigned to "a", "b", "c" and "d" for ease of understanding the latin square design layout. 

```{r Design and Randomisation, echo = FALSE}

suppressPackageStartupMessages({
library(dplyr, quietly = TRUE)
library(knitr)
library(tibble)
library(agricolae)
library(tidyr)
library(EDproject)
library(ggplot2)
library(tinytex)
library(emmeans)}
)

# model: essentially, side and variety are treated as treatment factors w 2 levels each, resulting in 4 combinations in a factorial experiment. light and heat are treated as blocking factors within each greenhouse-season block. 4, 4x4 lsds are created with rows corresponding to light levels and columns corresponding to heat levels and the four side-variety treatments are assigned in a standard 4x4 lsd. the model ends up being Y = mu + heat + light + season + greenhouse + side + variety + side*variety + heat*light + variety*heat + variety*light + variety*heat*light + error term. end up with 16 replicates per treatment of side-variety

set.seed(15)

# treatments 
treatments2 <- c("n,R", "s,F", "n,F", "s,R")

# create design (again oh my god)

mydesign2 <- expand.grid(season = 1:2, greenhouse = c("A", "B") ) %>%
  
  # new lsd for each season-greenhouse block w individual seed
  mutate(
    square_id = 1:n(),
    latin_seed = 15 + square_id
  ) %>%
  rowwise() %>% 
  mutate(
    latin_square = list(
      design.lsd(treatments2, serie = 0, seed = latin_seed)$book)
  ) %>%
  ungroup() %>% 
  
  # getting latin square into separate elements to be able to put it into the data frame 
  tidyr::unnest(latin_square) %>%
  rename(
    row = row,
    column = col,
    treatment = treatments2
  ) %>%
  
  # splitting the treatments into individual factors applied to put into design
  separate(treatment, into = c("side", "variety"), sep = ",") %>%
mutate(
    light = row,    # rows correspond to light levels (1-4)
    heat = column   # columns correspond to heat levels (1-4)
  ) %>%
  
# adding plot numbers (1-32 for season 1, 2)
  group_by(season) %>%
  mutate(plot = 1:n()) %>%
  ungroup() %>%
  select(plot, season, greenhouse, side, variety, light, heat) %>%
  arrange(season, plot) 

write.csv(mydesign2, file = "design2.csv", row.names = FALSE)

```


```{r making tables of the latin square designs, echo = FALSE}

set.seed(2)
treatment_mapping <- data.frame(
  side = c("n", "s", "n", "s"),
  variety = c("R", "F", "F", "R")
) %>%
  mutate(
    treatment = paste0(side, variety),
    code = sample(c("a", "b", "c", "d"))   # Random assignment 
  ) %>% 
  arrange(code)

# Create the complete data frame with codes
design_with_codes <- mydesign2 %>%
  # First, handle duplicates by taking the first occurrence
  group_by(season, greenhouse, light, heat) %>%
  slice(1) %>%
  ungroup() %>%
  # Add the treatment code
  mutate(treatment = paste0(side, variety)) %>%
  left_join(treatment_mapping %>% select(treatment, code), by = "treatment") %>%
  # Select and order the columns
  select(plot, season, greenhouse, side, variety, treatment, code, light, heat) %>%
  arrange(season, greenhouse, heat)

# making the latin square layouts
key <- tibble(treatment = treatment_mapping$treatment,
              code = treatment_mapping$code)
kable(key, caption = "Randomly assigned treatment codes")
lsd1 <- tibble(light_lvl = c(1, 2, 3, 4),
               design_with_codes$code[1:4],
               design_with_codes$code[5:8],
               design_with_codes$code[9:12],
               design_with_codes$code[13:16]
)
kable(lsd1, col.names = c("","1", "2", "3", "4"), caption = "LSD for Greenhouse A, Season 1")

lsd2 <- tibble(light_lvl = c(1, 2, 3, 4),
               design_with_codes$code[17:20],
               design_with_codes$code[21:24],
               design_with_codes$code[25:28],
               design_with_codes$code[29:32]
)
kable(lsd2, col.names = c("","1", "2", "3", "4"), caption = "LSD for Greenhouse B, Season 1")

lsd3 <- tibble(light_lvl = c(1, 2, 3, 4),
               design_with_codes$code[33:36],
               design_with_codes$code[37:40],
               design_with_codes$code[41:44],
               design_with_codes$code[45:48]
)
kable(lsd3, col.names = c("","1", "2", "3", "4"), caption = "LSD for Greenhouse A, Season 2")

lsd4 <- tibble(light_lvl = c(1, 2, 3, 4),
               design_with_codes$code[49:52],
               design_with_codes$code[53:56],
               design_with_codes$code[57:60],
               design_with_codes$code[61:64]
)
kable(lsd4, col.names = c("","1", "2", "3", "4"), caption = "LSD for Greenhouse B, Season 2")

```

## Hypotheses 

The a-priori hypotheses that are of interest are:

1: Does the main effect of light have an effect on quality?

2: Does the main effect of heat have an effect on quality?

3: Does the interaction effect between light and heat have an effect on quality?

4: Does the interaction effect between light and variety have an effect on quality? 

5: Does the interaction effect between heat and variety have an effect on quality?

6: Does the main effect of variety have an effect on quality? 

## Justification 
The factorial treatment structure with side and variety (each with two levels) crossed to give four treatment combinations allows for the main effects of variety and side to be tested as well as the interaction effect between side and variety. This allows for the effect of variety on quality to be analysed. 

The four latin squares, with light and heat as blocking factors with four levels each allows for analysis of the variation due to light and heat in a balanced design as there are four treatments that correspond to the four experimental units in each row or column with each treatment only appearing once in each column and row. This is also an efficient use of resources as 4 replicates of side and variety combinations are available per latin square. The latin structure also allows for the effects of light and heat on quality to be analysed thoroughly and easily. 

Additionally, the factorial treatment structure in conjunction with the latin square design allows for the interactions between light and variety, and heat and variety to be analysed. 

The replication across season-greenhouse blocks accounts for the variation due to season and the variation due to greenhouse and ensures sufficient power for the experiment as the 4 blocks result in $4 \times 4 = 16$ replicates per treatment. 

Essentially, this design allows for efficient analysis of all the a-priori hypotheses of interest and allows for many sources of variation to be accounted for. 


# Analysis and Results
```{r Simulating observations, echo = FALSE}

set.seed(27)  

mydesign2 <- read.csv("design2.csv")
mydesign2$light <- as.factor(mydesign2$light)
mydesign2$heat <- as.factor(mydesign2$heat)
mydesign2$season <- as.factor(mydesign2$season)
#mydesign2
mydata2 <- get.observations(mydesign2)
mydata2

```
## Analysis

### The model:

$$
Y_{ijklmn} = \mu+ \alpha_i + \beta_j + \gamma_k + \delta_l + (\gamma\delta)_{kl} + \epsilon_m + \theta_n + (\epsilon\theta)_{mn} + (\delta\epsilon)_{km} + (\delta\theta)_{kn} (\delta\epsilon\theta)_{lmn} + e_{ijklmn} 
$$

$$
\begin{aligned}
Y_{ijklmn} &= \text{quality score for observation ijklmn}\\
\alpha_i &= \text{effect of Season 2 compared to Season 1, $i = 1,2$}\\
\beta_j &= \text{effect of Greenhouse B compared to Greenhouse A, $j = A, B$}\\
\gamma_k &= \text{effect of side north compared to south, $k = s, n$}\\
\delta_l &= \text{effect of variety R compared to F, $l = F, R$}\\
\epsilon_m &= \text{effect of $i^{th}$ light level compared to $1^{st}$ level, $1 < i \leq 4$}\\
\theta_n &= \text{effect of $j^{th}$ heat level compared to $1^{st}$ level, $1 < j \leq 4$}
\end{aligned}
$$

An anova table was constructed based on this model with corner-point constraints for each variable as such: 
$$
\begin{aligned}
\alpha_1 &= 0 & \text{(Season 1 as reference)} \\
\beta_A &= 0 & \text{(Greenhouse A as reference)} \\
\gamma_s &= 0 & \text{(Side north as reference)} \\
\delta_F &= 0 & \text{(Variety Furious as reference)} \\
\epsilon_1 &= 0 & \text{(Light level 1 as reference)} \\
\theta_1 &= 0 & \text{(Heat level 1 as reference)}
\end{aligned}
$$

```{r fit model for later, echo = FALSE}
model <- lm (obs ~ season + greenhouse + variety*side + light*heat*variety, data=mydata2)
```


### Exploratory Data Analysis 
```{r histogram, fig.cap = "Histogram of quality score", echo = FALSE}
hist(mydata2$obs, xlab = "Quality score", freq = FALSE, main = "")

```

The histogram of quality score suggests slightly left-skewed data. 

#### Interaction Plots

```{r interaction plot 1, fig.cap = "Interaction plot of light and heat", echo = FALSE}
with(na.omit(mydata2), interaction.plot(light, heat, obs))
```

```{r interaction plot 2, fig.cap = "Interaction plot of light and variety", echo = FALSE}
with(na.omit(mydata2), interaction.plot(light, variety, obs))
```

```{r interaction plot 3, fig.cap = "Interaction plot of heat and variety", echo = FALSE}
with(na.omit(mydata2), interaction.plot(heat, variety, obs))
```

```{r interaction plot 4, fig.cap = "Interaction plot of variety and side", echo = FALSE}
with(na.omit(mydata2), interaction.plot(variety, side, obs))
```

The interaction plot between light and heat suggests that there is minimal interaction between the four levels of each. The interaction plot between variety and side also suggests that there is minimal interaction between side and variety. 
On the other hand, the interaction plots between light and variety and heat and variety suggest some interaction effect. 

#### Boxplots 

```{r boxplot 1, fig.cap = "Boxplot of light levels", echo = FALSE, warning = FALSE}
library(ggplot2)
with(na.omit(mydata2), ggplot(data = mydata2, aes(x = light, y = obs))) + 
  geom_boxplot(fill = "turquoise") + 
  scale_x_discrete(limits = c("1", "2", "3", "4")) +
  labs(x = "light", y = "quality score")

```

```{r boxplot 2, fig.cap = "Boxplot of heat levels", echo = FALSE, warning = FALSE}
with(na.omit(mydata2), ggplot(data = mydata2, aes(x = heat, y = obs))) + 
  geom_boxplot(fill = "purple3") + 
  scale_x_discrete(limits = c("1", "2", "3", "4")) +
  labs(x = "heat", y = "quality score")

```

```{r boxplot 3, fig.cap = "Boxplot of variety", echo = FALSE, warning = FALSE}
with(na.omit(mydata2), ggplot(data = mydata2, aes(x = variety, y = obs))) + 
  geom_boxplot(fill = "pink2") + 
  #scale_x_discrete(limits = c("F", "R")) +
  labs(x = "variety", y = "quality score")

```


```{r boxplot 4, fig.cap = "Boxplot of season", echo = FALSE, warning = FALSE}
with(na.omit(mydata2), ggplot(data = mydata2, aes(x = as.factor(season), y = obs))) + 
  geom_boxplot(fill = "lightblue3") + 
  scale_x_discrete(limits = c("1", "2")) +
  labs(x = "season", y = "quality score")

```

```{r boxplot 5, fig.cap = "Boxplot of greenhouse", echo = FALSE, warning = FALSE}
with(na.omit(mydata2), ggplot(data = mydata2, aes(x = greenhouse, y = obs))) + 
  geom_boxplot(fill = "darkgreen") + 
  scale_x_discrete(limits = c("A", "B")) +
  labs(x = "greenhouse", y = "quality score")

```

```{r boxplot 6, fig.cap = "Boxplot of side", echo = FALSE, warning = FALSE}
with(na.omit(mydata2), ggplot(data = mydata2, aes(x = side, y = obs))) + 
  geom_boxplot(fill = "red4") + 
  scale_x_discrete(limits = c("n", "s")) +
  labs(x = "side", y = "quality score")

```

```{r residuals plot 1, fig.cap = "Q-Q plot of residuals", echo = FALSE, warning = FALSE}
# 2. Normal Q-Q Plot
qqnorm(residuals(model), main = "", pch = 16,
       col = rgb(0.2, 0.2, 0.8, 0.6))
qqline(residuals(model), col = "red4", lwd = 2)
```

## Results

```{r anova table, echo = FALSE}
kable(model$coefficients, caption = "Estimates table")
kable(anova(model), caption = "ANOVA table")

```

### Question 1: Does the main effect of light have an effect on quality?

```{r question 1, echo = FALSE}

confints <- rbind(confint(model, parm = "light2") |> signif(4), confint(model, parm = "light3") |> signif(5), confint(model, parm = "light4") |> signif(4))

q2 <- tibble(light_level = c("Level 2", "Level 3", "Level 4"),
    Estimate = model$coefficients[6:8] |> signif(4),
   Lower_bound = confints[,1],
  Upper_bound = confints[,2],
)
kable(q2, caption = "95% Confidence Intervals of main effect of light levels in relation to light level 1", col.names = c("Light", "Estimate", "Lower bound", "Upper bound"))

```

Our analysis provides strong evidence for the main effect of light having an effect on quality (p-val < 0.00001). The mean response with light level 2 was 7.157 higher than with light level 1, with a 95% confidence interval = (3.212, 11.102). The mean response with level 3 was 11.332 higher than with level 1 (7.731, 14.932). The mean response with level 4 was 14.043 higher than with level 1 (10.992, 17.094).
Visually, the boxplots indicate that light level 3 actually had the highest median response, although level 4 had the highest mean response.

### Question 2: Does the main effect of heat have an effect on quality?

```{r q2, echo = FALSE}

confints <- rbind(confint(model, parm = "heat2") |> signif(4), confint(model, parm = "heat3") |> signif(5), confint(model, parm = "heat4") |> signif(4))

q2 <- tibble(Heat_level = c("Level 2", "Level 3", "Level 4"),
    Estimate = model$coefficients[9:11] |> signif(4),
   Lower_bound = confints[,1],
  Upper_bound = confints[,2],
)
kable(q2, caption = "95% Confidence Intervals of main effect of heat levels in relation to heat level 1", col.names = c("Heat", "Estimate", "Lower bound", "Upper bound"))

```

Our analysis provides strong evidence for the main effect of heat having an effect on quality (p-val < 0.00001). The mean response with heat level 2 was 5.902 higher than with level 1 (2.569, 9.235). The mean response with heat level 3 was 6.809 higher than with level 1 (3.518, 10.099). The mean response with level 4 was 5.690 higher than with level 1 (2.090, 9.291). 
Visually, the boxplots indicate that heat level 3, as well as having the highest mean response, also had the highest median response.

### Question 3: Does the interaction effect between light and heat have an effect on quality?

Our analysis does not provide sufficient evidence for an interaction between light and heat having an effect on quality (p-val = 0.240).

### Question 4: Does the interaction effect between light and variety have an effect on quality? 

Our analysis provides evidence for the interaction effect between variety and light (p-val < 0.005) having an effect on quality. Therefore, we proceeded with a contrast:

$$
L_1: \frac{1}{4}(\mu_{1R} + \mu_{2R} + \mu_{3R} + \mu_{4R}) - \frac{1}{4}(\mu_{1F} + \mu_{2F} + \mu_{3F} + \mu_{4F}) 
$$
to test:

$$
\begin{aligned}
L_1 = 0 \\
L_1 \ne 0 \\
\end{aligned}
$$
using a t-test. 
```{r q4, echo = FALSE}

emm_l <- emmeans(model, ~ variety*light)

emm_l_summary <- as.data.frame(emm_l)
emm_l_output <- tibble(Light = emm_l_summary$light,
                      Variety = emm_l_summary$variety,
                      emmean = emm_l_summary$emmean |> signif(5))

kable(emm_l_output)

contrast1 <- as.data.frame(contrast(emm_l, list(avg_R_minus_avg_F = c(rep(1/4, 4), rep(-1/4, 4)) ), by = NULL))

contrast1_output <- tibble(Estimate = contrast1$estimate,
                           SE = contrast1$SE,
                           df = contrast1$df,
                           t.value = contrast1$t.ratio,
                           p.value = contrast1$p.value) |> signif(4)
kable(contrast1_output, col.names = c("Estimate", "SE", "Degrees of Freedom", "t statistic", "p-value"), caption = "")

```
Our t-test produces a statistically significant result (p-val < 0.0001). Therefore, there is strong evidence that the interaction effect between variety and light level has an effect on the quality of chillies. 

### Question 5: Does the interaction effect between heat and variety have an effect on quality?

Our analysis provides evidence for the interaction effect between variety and heat (p-val < 0.05) having an effect on quality. Therefore, we proceeded with a contrast:

$$
L_2:\frac{1}{4}(\mu_{1R} + \mu_{2R} + \mu_{3R} + \mu_{4R}) - \frac{1}{4}(\mu_{1F} + \mu_{2F} + \mu_{3F} + \mu_{4F})
$$

to test:
$$
\begin{aligned}
L_2 = 0 \\
L_2 \ne 0 \\
\end{aligned}
$$
using a t-test. 
```{r q5, echo = FALSE}

emm_h <- emmeans(model, ~ variety*heat)
emm_h_summary <- as.data.frame(emm_h)
emm_h_output <- tibble(Heat = emm_h_summary$heat,
                       Variety = emm_h_summary$variety, 
                       emmean = emm_h_summary$emmean |> signif(5))

kable(emm_h_output, caption = "Estimated marginal means for heat and variety combinations")

contrast2 <- as.data.frame(contrast(emm_h, list(avg_R_minus_avg_F = c(rep(1/4, 4), rep(-1/4, 4))), by = NULL ))

contrast2_output <- tibble(Estimate = contrast2$estimate,
                           SE = contrast2$SE, 
                           df = contrast2$df,
                           t.value = contrast2$t.ratio,
                           p.value = contrast2$p.value |> signif(4))

kable(contrast2_output, col.names = c("Estimate", "SE", "Degrees of Freedom", "t statistic", "p-value"), caption = "")
```
Our t-test produces a statistically significant result (p-val < 0.0001). Therefore, we have strong evidence that the interaction effect between variety and heat has an effect on quality.

### Question 6: Does the main effect of variety have an effect on quality? 

Our analysis does not provide evidence for the main effect of variety having an effect on quality (p-val = 0.240).
Visually, the boxplots indicate that the median responses for both varieties were very similar, when averaging across all other variables.

### Further analysis

```{r further analysis, echo = FALSE}

emmeans(model, ~ light)

```


# Conclusion and Recommendations

## Conclusion

Your assignment is to design and analyse an experiment to help the two chilli farmers find the
best settings for growing chillies and to help to understand how the requirements for the two
varieties may differ.

The key aim of this assignment was to investigate the effects of different light and heat settings on the quality of chillies, and to determine which other factors influenced these results. 
We investigated the main effects of light, heat, variety, side, greenhouse and season on chilli growth, as well as various interaction terms between these different factors and treatments.
Our choice of design was 

### Which light and heat settings produce the highest quality chillies?

From the ANOVA table, there was no evidence for the interaction term between light and heat being significant (p-val = 0.2643), nor the interaction term between light, heat and variety (p-val = 0.218). 
However, there is evidence for the interaction term between light and variety being significant (p-val = 0.0032), as well as the interaction term between heat and variety (p-val = 0.0297).
Therefore, to determine the best light and heat settings, we calculated estimated means for heat and light for both varieties, averaging across all levels of other explanatory variables.
Our results suggest that the settings that produced the highest quality chillies, on average, were different between the two varieties of chilli.
For variety F, the light setting that produced the highest quality chillies on average, was level 4, with a mean response of 53.6 (52.6, 55.2). The optimal heat setting was level 3 with a mean response of 52.5 (51.3, 53.6).
For variety R, the optimal light setting was level 4, with a mean response of 54.4 (53.1, 55.7). The optimal heat level 4, with a mean response of 51.1 (49.8, 52.4).
Since the interactions between light, heat and variety were not significant, for each variety, the light and heat settings that would produce the highest quality chillies on average, were simply the settings that had the highest individual means.
Therefore, for variety F, the optimal settings were light level 4 and heat level 3.
For variety R, the optimal settings were light level 4 and heat level 4.


