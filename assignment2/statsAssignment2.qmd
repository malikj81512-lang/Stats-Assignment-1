---
title: "ED Assignment"
format: pdf
editor: visual
author: Malik Jamie (JMXMAL003) and Amara Patel (PTLAMA005)
date: 2025.10.22
---

# Plagiarism Statement 
I, Malik Jamie, declare that I have not plagiarised in this assignment.

I, Amara Patel, declare that I have not plagiarised in this assignment. 

# Introduction

The aim of this experiment is to examine the effects of different intensities of heat and light on the growth of chilli plants. The goal is to determine whether light and heat affect chilli growth, which settings produce the highest quality chillies and by how much. Furthermore, whether these settings depend on variety as well as whether quality depends on variety will be explored. This is to make recommendations about which heat and light settings are optimal for small-scale farmers to implement, taking into account the cost of additional heat and light. The effects of various sources of potential variation - season, greenhouse and side of the greenhouse - will also be explored.

These goals will be tackled through exploratory data analysis, and an analysis of variance of this exploratory experiment.

# Design and Randomisation

## Design

The experiment takes place over 2 seasons -- season 1 and season 2. There are two greenhouses available -- greenhouse A and greenhouse B -- with 8 north-facing and 8 south-facing plots each. The 32 experimental units were first blocked by the random factors, season and greenhouse, to give four blocks of 16 experimental units each. The treatment factors are side (north & south) and variety (Redhot & Furious), each with two levels which results in a $2^2$ factorial treatment structure with 4 treatments: (n,F), (s,F), (n,R), (s,R).

## Randomisation

Four 4x4 latin square designs were set up with the four levels of light (1, 2, 3, 4) as a row block and the four levels of heat (1, 2, 3, 4) as a column block. To conduct randomisation, a random latin square permutation of the four treatments, with each appearing once in every row and column, was found for each season-greenhouse combination using the design.lsd function from the agricolae package. The four treatments were randomly assigned to "a", "b", "c" and "d" for ease of understanding the latin square design layout. 

```{r Design and Randomisation, echo = FALSE}

suppressPackageStartupMessages({
library(dplyr, quietly = TRUE)
library(knitr)
library(tibble)
library(agricolae)
library(tidyr)
library(EDproject)
library(ggplot2)
library(tinytex)
library(emmeans)}
)

# model: essentially, side and variety are treated as treatment factors w 2 levels each, resulting in 4 combinations in a factorial experiment. light and heat are treated as blocking factors within each greenhouse-season block. 4, 4x4 lsds are created with rows corresponding to light levels and columns corresponding to heat levels and the four side-variety treatments are assigned in a standard 4x4 lsd. the model ends up being Y = mu + heat + light + season + greenhouse + side + variety + side*variety + heat*light + variety*heat + variety*light + variety*heat*light + error term. end up with 16 replicates per treatment of side-variety

set.seed(15)

# treatments 
treatments2 <- c("n,R", "s,F", "n,F", "s,R")

# create design (again oh my god)

mydesign2 <- expand.grid(season = 1:2, greenhouse = c("A", "B") ) %>%
  
  # new lsd for each season-greenhouse block w individual seed
  mutate(
    square_id = 1:n(),
    latin_seed = 15 + square_id
  ) %>%
  rowwise() %>% 
  mutate(
    latin_square = list(
      design.lsd(treatments2, serie = 0, seed = latin_seed)$book)
  ) %>%
  ungroup() %>% 
  
  # getting latin square into separate elements to be able to put it into the data frame 
  tidyr::unnest(latin_square) %>%
  rename(
    row = row,
    column = col,
    treatment = treatments2
  ) %>%
  
  # splitting the treatments into individual factors applied to put into design
  separate(treatment, into = c("side", "variety"), sep = ",") %>%
mutate(
    light = row,    # rows correspond to light levels (1-4)
    heat = column   # columns correspond to heat levels (1-4)
  ) %>%
  
# adding plot numbers (1-32 for season 1, 2)
  group_by(season) %>%
  mutate(plot = 1:n()) %>%
  ungroup() %>%
  select(plot, season, greenhouse, side, variety, light, heat) %>%
  arrange(season, plot) 

write.csv(mydesign2, file = "design2.csv", row.names = FALSE)

```


```{r making tables of the latin square designs, echo = FALSE}

set.seed(2)
treatment_mapping <- data.frame(
  side = c("n", "s", "n", "s"),
  variety = c("R", "F", "F", "R")
) %>%
  mutate(
    treatment = paste0(side, variety),
    code = sample(c("a", "b", "c", "d"))   # Random assignment 
  ) %>% 
  arrange(code)

# Create the complete data frame with codes
design_with_codes <- mydesign2 %>%
  # First, handle duplicates by taking the first occurrence
  group_by(season, greenhouse, light, heat) %>%
  slice(1) %>%
  ungroup() %>%
  # Add the treatment code
  mutate(treatment = paste0(side, variety)) %>%
  left_join(treatment_mapping %>% select(treatment, code), by = "treatment") %>%
  # Select and order the columns
  select(plot, season, greenhouse, side, variety, treatment, code, light, heat) %>%
  arrange(season, greenhouse, heat)

# making the latin square layouts
key <- tibble(treatment = treatment_mapping$treatment,
              code = treatment_mapping$code)
kable(key, caption = "Randomly assigned treatment codes")
lsd1 <- tibble(light_lvl = c(1, 2, 3, 4),
               design_with_codes$code[1:4],
               design_with_codes$code[5:8],
               design_with_codes$code[9:12],
               design_with_codes$code[13:16]
)
kable(lsd1, col.names = c("","1", "2", "3", "4"), caption = "LSD for Greenhouse A, Season 1")

lsd2 <- tibble(light_lvl = c(1, 2, 3, 4),
               design_with_codes$code[17:20],
               design_with_codes$code[21:24],
               design_with_codes$code[25:28],
               design_with_codes$code[29:32]
)
kable(lsd2, col.names = c("","1", "2", "3", "4"), caption = "LSD for Greenhouse B, Season 1")

lsd3 <- tibble(light_lvl = c(1, 2, 3, 4),
               design_with_codes$code[33:36],
               design_with_codes$code[37:40],
               design_with_codes$code[41:44],
               design_with_codes$code[45:48]
)
kable(lsd3, col.names = c("","1", "2", "3", "4"), caption = "LSD for Greenhouse A, Season 2")

lsd4 <- tibble(light_lvl = c(1, 2, 3, 4),
               design_with_codes$code[49:52],
               design_with_codes$code[53:56],
               design_with_codes$code[57:60],
               design_with_codes$code[61:64]
)
kable(lsd4, col.names = c("","1", "2", "3", "4"), caption = "LSD for Greenhouse B, Season 2")

```

## Hypotheses 

The a-priori hypotheses that are of interest are:

1: Does the main effect of light have an effect on quality?

2: Does the main effect of heat have an effect on quality?

3: Does the interaction effect between light and heat have an effect on quality?

4: Does the interaction effect between light and variety have an effect on quality? 

5: Does the interaction effect between heat and variety have an effect on quality?

6: Does the main effect of variety have an effect on quality? 

## Justification 
The factorial treatment structure with side and variety -- each with two levels crossed to give four treatment combinations -- allows for the main effects of variety and side to be tested as well as the interaction effect between side and variety. This allows for the effect of variety on quality to be analysed. 

The four latin squares, with light and heat as blocking factors with four levels each, allows for analysis of the variation due to light and heat in a balanced design, as there are four treatments that correspond to the four experimental units in each row or column with each treatment only appearing once in each column and row. This is also an efficient use of resources as 4 replicates of each side and variety combination are available per latin square. The latin structure also allows for the effects of light and heat on quality to be analysed thoroughly and easily. 

Additionally, the factorial treatment structure in conjunction with the latin square design allows for the interactions between light and variety, and heat and variety to be analysed. 

The replication across season-greenhouse blocks accounts for the variation due to season and the variation due to greenhouse, as well as ensuring sufficient power for the experiment as the 4 blocks result in $4 \times 4 = 16$ replicates per treatment. 

Essentially, this design allows for efficient analysis of all the a-priori hypotheses of interest and enables many sources of variation to be accounted for. 


# Analysis and Results
```{r Simulating observations, echo = FALSE}

# setting light and heat to be factors 
mydesign2 <- read.csv("design2.csv")
mydesign2$light <- as.factor(mydesign2$light)
mydesign2$heat <- as.factor(mydesign2$heat)
mydesign2$season <- as.factor(mydesign2$season)

# getting observations 
set.seed(27)  
mydata2 <- get.observations(mydesign2)


```
## Analysis

### The model:

$$
Y_{ijklmn} = \mu+ \alpha_i + \beta_j + \gamma_k + \delta_l + (\gamma\delta)_{kl} + \epsilon_m + \theta_n + (\epsilon\theta)_{mn} + (\delta\epsilon)_{km} + (\delta\theta)_{kn} + (\delta\epsilon\theta)_{lmn} + e_{ijklmn} 
$$
$$
e_{ijklmn}~ \text{are distributed} ~N(0, \sigma^2)
$$

$$
\begin{aligned}
Y_{ijklmn} &= \text{quality score for observation ijklmn}\\
\alpha_i &= \text{effect of $i^{th}$ season, $i = 1,2$}\\
\beta_j &= \text{effect of $j^{th}$ greenhouse, $j = A, B$}\\
\gamma_k &= \text{effect of $k^{th}$ side, $k = s, n$}\\
\delta_l &= \text{effect of $l^{th}$ variety, $l = F, R$}\\
\epsilon_m &= \text{effect of $m^{th}$ light level, $1 \leq i \leq 4$}\\
\theta_n &= \text{effect of $n^{th}$ heat level, $1 \leq j \leq 4$}
\end{aligned}
$$

An anova table was constructed based on this model with corner-point constraints for each variable as such: 
$$
\begin{aligned}
\alpha_1 &= 0 & \text{(Season 1 as reference)} \\
\beta_A &= 0 & \text{(Greenhouse A as reference)} \\
\gamma_n &= 0 & \text{(Side north as reference)} \\
\delta_F &= 0 & \text{(Variety Furious as reference)} \\
\epsilon_1 &= 0 & \text{(Light level 1 as reference)} \\
\theta_1 &= 0 & \text{(Heat level 1 as reference)}
\end{aligned}
$$

```{r fit model for later, echo = FALSE}
model <- lm (obs ~ season + greenhouse + variety*side + light*heat*variety, data=mydata2)
```


### Exploratory Data Analysis 
```{r histogram, fig.cap = "Histogram of quality score", echo = FALSE}
hist(mydata2$obs, xlab = "Quality score", freq = FALSE, main = "")

```

The histogram of quality score suggests slightly left-skewed data. Additionally, when examining the data, two observations are missing due to unforeseen circumstances. Our analysis will be adjusted to account for these missing observations by using least squares estimates with the observations removed and the degrees of freedom reduced. 

#### Interaction Plots

```{r interaction plot 1, fig.cap = "Interaction plot of light and heat", echo = FALSE}
with(na.omit(mydata2), interaction.plot(light, heat, obs))
```

```{r interaction plot 2, fig.cap = "Interaction plot of light and variety", echo = FALSE}
with(na.omit(mydata2), interaction.plot(light, variety, obs))
```

```{r interaction plot 3, fig.cap = "Interaction plot of heat and variety", echo = FALSE}
with(na.omit(mydata2), interaction.plot(heat, variety, obs))
```

```{r interaction plot 4, fig.cap = "Interaction plot of variety and side", echo = FALSE}
with(na.omit(mydata2), interaction.plot(variety, side, obs))
```

The interaction plot between light and heat suggests that there is minimal interaction between the four levels of each. The interaction plot between variety and side also suggests that there is minimal interaction between side and variety. 
On the other hand, the interaction plots between light and variety and heat and variety suggest some interaction effect. 

#### Boxplots 

```{r boxplot 1, fig.cap = "Boxplot of light levels", echo = FALSE, warning = FALSE}
library(ggplot2)
with(na.omit(mydata2), ggplot(data = mydata2, aes(x = light, y = obs))) + 
  geom_boxplot(fill = "turquoise") + 
  scale_x_discrete(limits = c("1", "2", "3", "4")) +
  labs(x = "light", y = "quality score")

```

```{r boxplot 2, fig.cap = "Boxplot of heat levels", echo = FALSE, warning = FALSE}
with(na.omit(mydata2), ggplot(data = mydata2, aes(x = heat, y = obs))) + 
  geom_boxplot(fill = "purple3") + 
  scale_x_discrete(limits = c("1", "2", "3", "4")) +
  labs(x = "heat", y = "quality score")

```

```{r boxplot 3, fig.cap = "Boxplot of variety", echo = FALSE, warning = FALSE}
with(na.omit(mydata2), ggplot(data = mydata2, aes(x = variety, y = obs))) + 
  geom_boxplot(fill = "pink2") + 
  #scale_x_discrete(limits = c("F", "R")) +
  labs(x = "variety", y = "quality score")

```


```{r boxplot 4, fig.cap = "Boxplot of season", echo = FALSE, warning = FALSE}
with(na.omit(mydata2), ggplot(data = mydata2, aes(x = as.factor(season), y = obs))) + 
  geom_boxplot(fill = "lightblue3") + 
  scale_x_discrete(limits = c("1", "2")) +
  labs(x = "season", y = "quality score")

```

```{r boxplot 5, fig.cap = "Boxplot of greenhouse", echo = FALSE, warning = FALSE}
with(na.omit(mydata2), ggplot(data = mydata2, aes(x = greenhouse, y = obs))) + 
  geom_boxplot(fill = "darkgreen") + 
  scale_x_discrete(limits = c("A", "B")) +
  labs(x = "greenhouse", y = "quality score")

```

```{r boxplot 6, fig.cap = "Boxplot of side", echo = FALSE, warning = FALSE}
with(na.omit(mydata2), ggplot(data = mydata2, aes(x = side, y = obs))) + 
  geom_boxplot(fill = "red4") + 
  scale_x_discrete(limits = c("n", "s")) +
  labs(x = "side", y = "quality score")

```

The boxplots show that, apart from the main hypotheses we are investigating: the effects of light, heat, variety and their interactions, there is a difference in median response from season 1 to season 2, as well as a difference in median response from the north side and south side of the two greenhouses.

## Results

```{r anova table, echo = FALSE}

kable(anova(model), caption = "ANOVA table")

```

### Question 1: Does the main effect of light have an effect on quality?

```{r question 1, echo = FALSE}

confints <- rbind(confint(model, parm = "light2") |> signif(4), confint(model, parm = "light3") |> signif(5), confint(model, parm = "light4") |> signif(4))

q2 <- tibble(light_level = c("Level 2", "Level 3", "Level 4"),
    Estimate = model$coefficients[6:8] |> signif(4),
   Lower_bound = confints[,1],
  Upper_bound = confints[,2],
)
kable(q2, caption = "95% Confidence Intervals of main effect of light levels in relation to light level 1", col.names = c("Light", "Estimate", "Lower bound", "Upper bound"))

```

The F-test we conducted provides strong evidence for the main effect of light having an effect on quality (p-val < 0.00001). The mean response with light level 2 was 7.157 higher than with light level 1, with a 95% confidence interval = (3.212, 11.102). The mean response with level 3 was 11.332 higher than with level 1 (7.731, 14.932). The mean response with level 4 was 14.043 higher than with level 1 (10.992, 17.094).
Visually, the boxplots indicate that light level 3 actually had the highest median response, although level 4 had the highest mean response.

### Question 2: Does the main effect of heat have an effect on quality?

```{r q2, echo = FALSE}

confints <- rbind(confint(model, parm = "heat2") |> signif(4), confint(model, parm = "heat3") |> signif(5), confint(model, parm = "heat4") |> signif(4))

q2 <- tibble(Heat_level = c("Level 2", "Level 3", "Level 4"),
    Estimate = model$coefficients[9:11] |> signif(4),
   Lower_bound = confints[,1],
  Upper_bound = confints[,2],
)
kable(q2, caption = "95% Confidence Intervals of main effect of heat levels in relation to heat level 1", col.names = c("Heat", "Estimate", "Lower bound", "Upper bound"))

```

The F-test provides strong evidence for the main effect of heat having an effect on quality (p-val < 0.00001). The mean response with heat level 2 was 5.902 higher than with level 1 (2.569, 9.235). The mean response with heat level 3 was 6.809 higher than with level 1 (3.518, 10.099). The mean response with level 4 was 5.690 higher than with level 1 (2.090, 9.291). 
Visually, the boxplots indicate that heat level 3, as well as having the highest mean response, also had the highest median response.

### Question 3: Does the interaction effect between light and heat have an effect on quality?

The F-test does not provide sufficient evidence for an interaction between light and heat having an effect on quality (p-val = 0.265).

### Question 4: Does the interaction effect between light and variety have an effect on quality? 

The F-test provides evidence for the interaction effect between variety and light (p-val < 0.005) having an effect on quality. Therefore, we proceeded with a contrast:

$$
L_1: \frac{1}{4}(\mu_{1R} + \mu_{2R} + \mu_{3R} + \mu_{4R}) - \frac{1}{4}(\mu_{1F} + \mu_{2F} + \mu_{3F} + \mu_{4F}) 
$$
to test:

$$
\begin{aligned}
L_1 = 0 \\
L_1 \ne 0 \\
\end{aligned}
$$
using a t-test. 
```{r q4, echo = FALSE}

suppressMessages({emm_l <- emmeans(model, ~ variety*light, weights = "proportional")})

emm_l_summary <- as.data.frame(emm_l)
emm_l_output <- tibble(Light = emm_l_summary$light,
                      Variety = emm_l_summary$variety,
                      emmean = emm_l_summary$emmean |> signif(5))

kable(emm_l_output)

contrast1 <- as.data.frame(contrast(emm_l, list(avg_R_minus_avg_F = c(rep(1/4, 4), rep(-1/4, 4)) ), by = NULL))

contrast1_output <- tibble(Estimate = contrast1$estimate,
                           SE = contrast1$SE,
                           df = contrast1$df,
                           t.value = contrast1$t.ratio,
                           p.value = contrast1$p.value) |> signif(4)
kable(contrast1_output, col.names = c("Estimate", "SE", "Degrees of Freedom", "t statistic", "p-value"), caption = "Result of t-test for contrast $L_1$")

```

For variety F, our results show that, averaged across all other variables, light level 4 produced the highest mean response (53.795), followed by level 3 (51.906).
For variety R, our results show that, averaged across all other variables, light level 4 produced the highest mean response (54.325), followed by level 3 (53.216).

Our t-test produces a statistically significant result (p-val < 0.0001). Therefore, there is strong evidence that the interaction effect between variety and light level has an effect on the quality of chillies. 

### Question 5: Does the interaction effect between heat and variety have an effect on quality?

Our analysis provides evidence for the interaction effect between variety and heat (p-val < 0.05) having an effect on quality. Therefore, we proceeded with a contrast:

$$
L_2:\frac{1}{4}(\mu_{1R} + \mu_{2R} + \mu_{3R} + \mu_{4R}) - \frac{1}{4}(\mu_{1F} + \mu_{2F} + \mu_{3F} + \mu_{4F})
$$

to test:
$$
\begin{aligned}
L_2 = 0 \\
L_2 \ne 0 \\
\end{aligned}
$$
using a t-test. 
```{r q5, echo = FALSE}

suppressMessages({emm_h <- emmeans(model, ~ variety*heat, weights = "proportional")})
emm_h_summary <- as.data.frame(emm_h)
emm_h_output <- tibble(Heat = emm_h_summary$heat,
                       Variety = emm_h_summary$variety, 
                       emmean = emm_h_summary$emmean |> signif(5))

kable(emm_h_output, caption = "Estimated marginal means for heat and variety combinations")

contrast2 <- as.data.frame(contrast(emm_h, list(avg_R_minus_avg_F = c(rep(1/4, 4), rep(-1/4, 4))), by = NULL ))

contrast2_output <- tibble(Estimate = contrast2$estimate,
                           SE = contrast2$SE, 
                           df = contrast2$df,
                           t.value = contrast2$t.ratio,
                           p.value = contrast2$p.value |> signif(4))

kable(contrast2_output, col.names = c("Estimate", "SE", "Degrees of Freedom", "t statistic", "p-value"), caption = "Result of t-test for contrast $L_2$")
```

For variety F, our results show that, averaged across all other variables, heat level 3 produced the highest mean response (52.250), followed by level 4 (49.830).
For variety R, our results show that, averaged across all other variables, heat level 4 produced the highest mean response (50.920), followed by level 3 (50.077).

Our t-test produces a statistically significant result (p-val < 0.0001). Therefore, we have strong evidence that the interaction effect between variety and heat has an effect on quality.

### Question 6: Does the main effect of variety have an effect on quality? 

The F-test we conducted does not provide evidence for the main effect of variety having an effect on quality (p-val = 0.240).
Visually, the boxplots indicate that the median responses for both varieties were very similar, when averaging across all other variables.

### Further Observations 

The F-test we conducted provides strong evidence for side having an effect on quality (p-val < 0.00001), as well as season having an effect on quality (p-val p-val < 0.00001).

# Conclusion and Recommendations

## Conclusion

The key aim of this assignment was to investigate the effects of different light and heat settings on the quality of chillies, and to determine which other factors influenced these results. We investigated the main effects of light, heat, variety, side, greenhouse and season on chilli quality, as well as various interaction terms between these different factors and treatments.

Our choice of design was a $2^2$ factorial treatment structure with 4 treatments, one for each variety-side combination, separated into 4 different latin square designs using greenhouse and season as initial blocking factors, and light and heat as row and column factors within each latin square.

Our results show strong evidence for different levels of lighting and heating having an effect on the quality of chillies. We found there was insufficient evidence for an interaction effect between heat and light levels, suggesting that the optimal settings for heat and light were simply the heat level and light level that individually produced the highest quality chillies. Additionally, while we did find that there were some differences in how the two varieties of chilli -- Redhot and Furious -- responded to the changes in heating and lighting, these differences were not particularly significant.

Low lighting produced extremely poor quality chillies, while increased lighting produced a better chilli quality score, with high to very high light levels yielding the best scores. We found the effect of heat to be less significant than light. Low heat produced relatively poor quality chillies, but increasing heat did not have anywhere near as large an effect as increasing light. Medium, high and very high heat levels appeared to have similar effects on quality.

Our analysis also suggests that chilli quality was significantly better on the north side of both greenhouses than on the south side.

In the context of Ms Hopeful and Mr Growing's differing yields, their methods of growing differed by heat, light and variety. Our results suggest that the key driver of this difference in quality was that Ms Hopeful used supplementary lighting (likely similar to our level 3 or 4 in testing), while Mr Growing used only standard lighting (likely similar to our level 1 or 2). 

Ms Hopeful also used supplementary heating, while Mr Growing did not. Our results show that this likely had an effect on their differing yields, but that it was not as large as the effect of the supplementary lighting.

Mr Growing grew Redhot chillies, which our results suggest are actually even more suited to high heat and light levels than the Furious variety which Ms Hopeful grew.
However, even if they grew the same variety of chilli, our results suggest that Ms Hopeful's yield would still be significantly higher than Mr Growing's. Therefore, we do not consider the difference in variety to be a key driver in the difference in chilli quality.

## Recommendations

Our analysis leads us to believe that supplementary lighting is highly recommended. Higher light levels seem to yield higher quality scores in both varieties of chilli. Some level of supplementary heating is also recommended, as it can produce an increase in chilli quality. However, there seems to be a cut-off point, as increasing heat past a certain point seems to have no significant impact or could even reduce quality.

We can not make any recommendation on the variety of chilli to grow, as their quality when averaging across all other factors appeared to be very similar. However, it seems that Redhot chillies are more sensitive to increased lighting than the Furious variety. 

Additional light and heat is costly. Since our results show evidence for a greater effect of additional lighting on chilli quality, it is more effective to allocate resources to maximise lighting instead of heat. A cost-effective combination of light and heat that would yield high quality chillies may not be the optimal levels of light level 4 and heat level 3, but instead light level 4 and heat level 2 for example. In general, some combination of medium to high heating and high to very high lighting is recommended for optimal chilli quality.

A cost-effective way of maximising chilli quality seems to be to grow chilli plants on the north side of the greenhouse.

# References 

RStudio Team (2025). Rstudio: Integrated Development Environment for R (Version 2025.09.1+401) [Computer software]. Posit Sofware, PBC. http://www.posit.co/

OpenAI. (2025). ChatGPT (Oct 21 version) [Large language model]. https://chat.openai.com/chat

Erni, B., Juritz, J., & Little, F. (2025, September). Design and analysis of experiments [Course notes]. University of Cape Town. https://amathuba.uct.ac.za

# Design and Data
```{r design and data, echo = FALSE}
kable(mydesign2, caption = "Design")
kable(mydata2, caption = "Data")
```

# R Code
```{r All the code, eval = FALSE}

suppressPackageStartupMessages({
library(dplyr, quietly = TRUE)
library(knitr)
library(tibble)
library(agricolae)
library(tidyr)
library(EDproject)
library(ggplot2)
library(tinytex)
library(emmeans)}
)

set.seed(15)

# treatments 
treatments2 <- c("n,R", "s,F", "n,F", "s,R")

# create design 

mydesign2 <- expand.grid(season = 1:2, greenhouse = c("A", "B") ) %>%
  
  # new lsd for each season-greenhouse block w individual seed
  mutate(
    square_id = 1:n(),
    latin_seed = 15 + square_id
  ) %>%
  rowwise() %>% 
  mutate(
    latin_square = list(
      design.lsd(treatments2, serie = 0, seed = latin_seed)$book)
  ) %>%
  ungroup() %>% 
  
  # getting latin square into separate elements to 
  #be able to put it into the data frame 
  tidyr::unnest(latin_square) %>%
  rename(
    row = row,
    column = col,
    treatment = treatments2
  ) %>%
  
  # splitting the treatments into individual factors applied 
  #to put into design
  separate(treatment, into = c("side", "variety"), sep = ",") %>%
mutate(
    light = row,    # rows correspond to light levels (1-4)
    heat = column   # columns correspond to heat levels (1-4)
  ) %>%
  
# adding plot numbers (1-32 for season 1, 2)
  group_by(season) %>%
  mutate(plot = 1:n()) %>%
  ungroup() %>%
  select(plot, season, greenhouse, side, variety, light, heat) %>%
  arrange(season, plot) 

write.csv(mydesign2, file = "design2.csv", row.names = FALSE)

# randomising

set.seed(2)
treatment_mapping <- data.frame(
  side = c("n", "s", "n", "s"),
  variety = c("R", "F", "F", "R")
) %>%
  mutate(
    treatment = paste0(side, variety),
    code = sample(c("a", "b", "c", "d"))   # Random assignment 
  ) %>% 
  arrange(code)

# Create the complete data frame with codes
design_with_codes <- mydesign2 %>%
  # First, handle duplicates by taking the first occurrence
  group_by(season, greenhouse, light, heat) %>%
  slice(1) %>%
  ungroup() %>%
  # Add the treatment code
  mutate(treatment = paste0(side, variety)) %>%
  left_join(treatment_mapping %>% select(treatment, code), 
            by = "treatment") %>%
  # Select and order the columns
  select(plot, season, greenhouse, side, variety, 
         treatment, code, light, heat) %>%
  arrange(season, greenhouse, heat)

# making the latin square layouts
key <- tibble(treatment = treatment_mapping$treatment,
              code = treatment_mapping$code)
kable(key, caption = "Randomly assigned treatment codes")
lsd1 <- tibble(light_lvl = c(1, 2, 3, 4),
               design_with_codes$code[1:4],
               design_with_codes$code[5:8],
               design_with_codes$code[9:12],
               design_with_codes$code[13:16]
)
kable(lsd1, col.names = c("","1", "2", "3", "4"), 
      caption = "LSD for Greenhouse A, Season 1")

lsd2 <- tibble(light_lvl = c(1, 2, 3, 4),
               design_with_codes$code[17:20],
               design_with_codes$code[21:24],
               design_with_codes$code[25:28],
               design_with_codes$code[29:32]
)
kable(lsd2, col.names = c("","1", "2", "3", "4"), 
      caption = "LSD for Greenhouse B, Season 1")

lsd3 <- tibble(light_lvl = c(1, 2, 3, 4),
               design_with_codes$code[33:36],
               design_with_codes$code[37:40],
               design_with_codes$code[41:44],
               design_with_codes$code[45:48]
)
kable(lsd3, col.names = c("","1", "2", "3", "4"), 
      caption = "LSD for Greenhouse A, Season 2")

lsd4 <- tibble(light_lvl = c(1, 2, 3, 4),
               design_with_codes$code[49:52],
               design_with_codes$code[53:56],
               design_with_codes$code[57:60],
               design_with_codes$code[61:64]
)
kable(lsd4, 
      col.names = c("","1", "2", "3", "4"), 
      caption = "LSD for Greenhouse B, Season 2")



# simulating observations
## setting light and heat to be factors 
mydesign2 <- read.csv("design2.csv")
mydesign2$light <- as.factor(mydesign2$light)
mydesign2$heat <- as.factor(mydesign2$heat)
mydesign2$season <- as.factor(mydesign2$season)

## getting observations 
set.seed(27)  
mydata2 <- get.observations(mydesign2)

# fit model 
model <- lm (obs ~ season + greenhouse + variety*side + light*heat*variety, 
             data=mydata2)

# histogram of quality 
hist(mydata2$obs, xlab = "Quality score", freq = FALSE, main = "")

# interaction plots 
with(na.omit(mydata2), interaction.plot(light, heat, obs))
with(na.omit(mydata2), interaction.plot(light, variety, obs))
with(na.omit(mydata2), interaction.plot(heat, variety, obs))
with(na.omit(mydata2), interaction.plot(variety, side, obs))


# boxplots
with(na.omit(mydata2), ggplot(data = mydata2, aes(x = light, y = obs))) + 
  geom_boxplot(fill = "turquoise") + 
  scale_x_discrete(limits = c("1", "2", "3", "4")) +
  labs(x = "light", y = "quality score")

with(na.omit(mydata2), ggplot(data = mydata2, aes(x = heat, y = obs))) + 
  geom_boxplot(fill = "purple3") + 
  scale_x_discrete(limits = c("1", "2", "3", "4")) +
  labs(x = "heat", y = "quality score")

with(na.omit(mydata2), ggplot(data = mydata2, aes(x = variety, y = obs))) + 
  geom_boxplot(fill = "pink2") + 
  #scale_x_discrete(limits = c("F", "R")) +
  labs(x = "variety", y = "quality score")

with(na.omit(mydata2), ggplot(data = mydata2, aes(x = as.factor(season),
                                                  y = obs))) + 
  geom_boxplot(fill = "lightblue3") + 
  scale_x_discrete(limits = c("1", "2")) +
  labs(x = "season", y = "quality score")

with(na.omit(mydata2), ggplot(data = mydata2, aes(x = greenhouse, y = obs))) + 
  geom_boxplot(fill = "darkgreen") + 
  scale_x_discrete(limits = c("A", "B")) +
  labs(x = "greenhouse", y = "quality score")


with(na.omit(mydata2), ggplot(data = mydata2, aes(x = side, y = obs))) + 
  geom_boxplot(fill = "red4") + 
  scale_x_discrete(limits = c("n", "s")) +
  labs(x = "side", y = "quality score")

# anova table

kable(anova(model), caption = "ANOVA table")

# hypotheses
# question 1

confints <- rbind(confint(model, parm = "light2") |> signif(4),
                  confint(model, parm = "light3") |> signif(5), 
                  confint(model, parm = "light4") |> signif(4))

q2 <- tibble(light_level = c("Level 2", "Level 3", "Level 4"),
    Estimate = model$coefficients[6:8] |> signif(4),
   Lower_bound = confints[,1],
  Upper_bound = confints[,2],
)
kable(q2, 
      caption = "95% Confidence Intervals of main effect of light levels in relation to light level 1", 
      col.names = c("Light", "Estimate", "Lower bound", "Upper bound"))

# question 2
confints <- rbind(confint(model, parm = "heat2") |> signif(4),
                  confint(model, parm = "heat3") |> signif(5), 
                  confint(model, parm = "heat4") |> signif(4))

q2 <- tibble(Heat_level = c("Level 2", "Level 3", "Level 4"),
    Estimate = model$coefficients[9:11] |> signif(4),
   Lower_bound = confints[,1],
  Upper_bound = confints[,2],
)
kable(q2, 
      caption = "95% Confidence Intervals of main effect of heat levels in relation to heat level 1", 
      col.names = c("Heat", "Estimate", "Lower bound", "Upper bound"))

# question 4

suppressMessages({emm_l <- emmeans(model, ~ variety*light,
                                   weights = "proportional")})

emm_l_summary <- as.data.frame(emm_l)
emm_l_output <- tibble(Light = emm_l_summary$light,
                      Variety = emm_l_summary$variety,
                      emmean = emm_l_summary$emmean |> signif(5))

kable(emm_l_output)

contrast1 <- as.data.frame(contrast(
  emm_l, 
  list(avg_R_minus_avg_F = c(rep(1/4, 4), rep(-1/4, 4)) ), by = NULL))

contrast1_output <- tibble(Estimate = contrast1$estimate,
                           SE = contrast1$SE,
                           df = contrast1$df,
                           t.value = contrast1$t.ratio,
                           p.value = contrast1$p.value) |> signif(4)
kable(contrast1_output, 
      col.names = c("Estimate", "SE", "Degrees of Freedom", "t statistic", "p-value"), 
      caption = "Result of t-test for contrast $L_1$")

# question 5

suppressMessages({emm_h <- emmeans(model, ~ variety*heat, weights = "proportional")})
emm_h_summary <- as.data.frame(emm_h)
emm_h_output <- tibble(Heat = emm_h_summary$heat,
                       Variety = emm_h_summary$variety, 
                       emmean = emm_h_summary$emmean |> signif(5))

kable(emm_h_output, caption = "Estimated marginal means for heat and variety combinations")

contrast2 <- as.data.frame(contrast(emm_h,
                                    list(avg_R_minus_avg_F = c(rep(1/4, 4), rep(-1/4, 4))),
                                    by = NULL))

contrast2_output <- tibble(Estimate = contrast2$estimate,
                           SE = contrast2$SE, 
                           df = contrast2$df,
                           t.value = contrast2$t.ratio,
                           p.value = contrast2$p.value |> signif(4))

kable(contrast2_output, 
      col.names = c("Estimate", "SE", "Degrees of Freedom", "t statistic", "p-value"), 
      caption = "Result of t-test for contrast $L_2$")
```
